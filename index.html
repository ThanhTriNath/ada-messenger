<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaMessenger - Service de Messagerie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-bubble-sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .chat-bubble-received {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .story-ring {
            background: linear-gradient(45deg, #f093fb, #f5576c, #667eea, #764ba2);
            padding: 4px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: pulse-ring 2s infinite;
        }
        .story-inner {
            background: white;
            border-radius: 50%;
            padding: 3px;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
            50% { box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4); }
            100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 to-pink-100 min-h-screen">
    <!-- √âcran de connexion -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">MessagApp</h1>
                <p class="text-gray-600 mt-2">Connectez-vous avec vos amis</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pseudo</label>
                    <input type="text" id="usernameInput" placeholder="Entrez votre pseudo" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <div class="relative">
                        <input type="password" id="passwordInput" placeholder="Entrez votre mot de passe" 
                               class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <button type="button" onclick="togglePasswordVisibility()" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <span id="passwordToggleIcon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button onclick="login()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition duration-200">
                        Se connecter
                    </button>
                    <button onclick="createAccount()" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-600 transition duration-200">
                        Cr√©er un compte
                    </button>
                </div>
                
                <div id="loginMessage" class="text-center text-sm hidden"></div>
            </div>
        </div>
    </div>

    <!-- Application principale -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <div id="sidebar" class="w-full md:w-80 bg-white shadow-lg flex flex-col md:relative absolute inset-0 z-40 transform transition-transform duration-300 ease-in-out">
            <!-- Header -->
            <div class="p-3 md:p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg md:text-xl font-bold text-gray-800">AdaMessenger</h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="logout()" class="text-red-500 hover:text-red-700 text-xs md:text-sm">
                            D√©connexion
                        </button>
                        <button id="closeSidebarBtn" onclick="closeSidebar()" class="md:hidden text-gray-500 hover:text-gray-700 text-xl">
                            ‚úï
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm md:text-base">
                        <span id="userInitial"></span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800 text-sm md:text-base" id="currentUserName"></p>
                        <p class="text-xs md:text-sm text-green-500">En ligne</p>
                    </div>
                </div>
            </div>

            <!-- Stories -->
            <div class="p-3 md:p-4 border-b border-gray-200">
                <h3 class="text-xs md:text-sm font-semibold text-gray-600 mb-3">Stories</h3>
                <div class="flex space-x-3 overflow-x-auto pb-2" id="storiesContainer">
                    <div class="story-ring flex-shrink-0 cursor-pointer" onclick="showCreateStoryModal()">
                        <div class="story-inner">
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-lg md:text-2xl">‚ûï</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contacts/Conversations -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-3 md:p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xs md:text-sm font-semibold text-gray-600">Conversations</h3>
                        <div class="flex space-x-2">
                            <button onclick="showAddContactModal()" class="text-purple-600 hover:text-purple-800 text-xs md:text-sm">
                                + Nouveau
                            </button>
                            <button onclick="showSettingsModal()" class="text-gray-600 hover:text-gray-800 text-xs md:text-sm">
                                ‚öôÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-3 md:p-4">
                    <div id="contactsList" class="space-y-3">
                        <!-- Les contacts seront ajout√©s ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay pour mobile -->
        <div id="sidebarOverlay" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-30" onclick="closeSidebar()"></div>

        <!-- Zone de chat -->
        <div class="flex-1 flex flex-col min-h-screen md:min-h-0">
            <!-- Chat vide -->
            <div id="emptyChatState" class="flex-1 flex items-center justify-center bg-gray-50 p-4">
                <div class="text-center max-w-sm">
                    <button onclick="openSidebar()" class="md:hidden mb-4 bg-purple-600 text-white px-4 py-2 rounded-lg">
                        üì± Voir les conversations
                    </button>
                    <div class="w-16 h-16 md:w-24 md:h-24 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl md:text-4xl text-white">üí¨</span>
                    </div>
                    <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Bienvenue sur MessagApp</h3>
                    <p class="text-sm md:text-base text-gray-500">S√©lectionnez une conversation ou cr√©ez-en une nouvelle</p>
                </div>
            </div>

            <!-- Interface de chat -->
            <div id="chatInterface" class="hidden flex-1 flex flex-col">
                <!-- Header du chat -->
                <div class="bg-white border-b border-gray-200 p-3 md:p-4">
                    <div class="flex items-center space-x-3">
                        <button onclick="openSidebar()" class="md:hidden text-purple-600 hover:text-purple-800 mr-2">
                            ‚Üê Retour
                        </button>
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm md:text-base">
                            <span id="chatContactInitial"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-gray-800 text-sm md:text-base truncate" id="chatContactName"></h3>
                            <p class="text-xs md:text-sm text-green-500">En ligne</p>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-3 md:p-4 bg-gray-50 space-y-4">
                    <!-- Les messages seront ajout√©s ici -->
                </div>

                <!-- Zone de saisie -->
                <div class="bg-white border-t border-gray-200 p-3 md:p-4">
                    <div class="flex items-center space-x-2 md:space-x-3">
                        <button onclick="showPhotoModal('message')" class="text-purple-600 hover:text-purple-800 flex-shrink-0">
                            <span class="text-lg md:text-xl">üì∑</span>
                        </button>
                        <button class="text-purple-600 hover:text-purple-800 flex-shrink-0 hidden sm:block">
                            <span class="text-lg md:text-xl">üìé</span>
                        </button>
                        <div class="flex-1 relative">
                            <input type="text" id="messageInput" placeholder="Tapez votre message..." 
                                   class="w-full px-3 md:px-4 py-2 text-sm md:text-base border border-gray-300 rounded-full focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <button onclick="sendMessage()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-2 rounded-full hover:from-purple-700 hover:to-pink-700 transition duration-200 flex-shrink-0">
                            <span class="text-lg md:text-xl">‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter un contact -->
    <div id="addContactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-md">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Ajouter un contact</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pseudo du contact</label>
                    <input type="text" id="contactUsernameInput" placeholder="Entrez le pseudo" 
                           class="w-full px-3 md:px-4 py-2 text-sm md:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div id="contactMessage" class="text-center text-sm hidden"></div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <button onclick="closeAddContactModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 md:py-3 rounded-lg hover:bg-gray-400 transition duration-200 text-sm md:text-base">
                        Annuler
                    </button>
                    <button onclick="addContact()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 md:py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition duration-200 text-sm md:text-base">
                        Ajouter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour cr√©er une story -->
    <div id="createStoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Cr√©er une story</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Texte de votre story</label>
                    <textarea id="storyTextInput" placeholder="Que voulez-vous partager ?" 
                              class="w-full px-3 md:px-4 py-2 text-sm md:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-20 md:h-24 resize-none"></textarea>
                </div>
                <div>
                    <button onclick="showPhotoModal('story')" class="w-full bg-blue-500 text-white py-2 md:py-3 rounded-lg hover:bg-blue-600 transition duration-200 mb-2 text-sm md:text-base">
                        üì∑ Ajouter une photo
                    </button>
                    <div id="storyPhotoPreview" class="hidden w-full h-24 md:h-32 bg-gray-100 rounded-lg flex items-center justify-center">
                        <canvas id="storyPhotoCanvas" class="max-w-full max-h-full rounded-lg"></canvas>
                    </div>
                </div>
                <div id="storyMessage" class="text-center text-sm hidden"></div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <button onclick="closeCreateStoryModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 md:py-3 rounded-lg hover:bg-gray-400 transition duration-200 text-sm md:text-base">
                        Annuler
                    </button>
                    <button onclick="createStory()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 md:py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition duration-200 text-sm md:text-base">
                        Publier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour prendre une photo -->
    <div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Prendre une photo</h3>
            <div class="space-y-4">
                <div class="bg-gray-100 rounded-lg p-2 md:p-4 text-center">
                    <canvas id="photoCanvas" width="300" height="225" class="border rounded-lg bg-white mx-auto max-w-full h-auto"></canvas>
                </div>
                <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <button onclick="drawRandomPhoto()" class="bg-blue-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 text-sm md:text-base">
                        üì∑ Prendre photo
                    </button>
                    <button onclick="clearPhoto()" class="bg-gray-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200 text-sm md:text-base">
                        üóëÔ∏è Effacer
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <button onclick="closePhotoModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 md:py-3 rounded-lg hover:bg-gray-400 transition duration-200 text-sm md:text-base">
                        Annuler
                    </button>
                    <button onclick="usePhoto()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 md:py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition duration-200 text-sm md:text-base">
                        Utiliser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal des param√®tres -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-md">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Param√®tres</h3>
            <div class="space-y-3">
                <button onclick="showManageContactsModal()" class="w-full bg-blue-500 text-white py-2 md:py-3 rounded-lg hover:bg-blue-600 transition duration-200 text-sm md:text-base">
                    üë• G√©rer mes contacts
                </button>
                <button onclick="showManageConversationsModal()" class="w-full bg-green-500 text-white py-2 md:py-3 rounded-lg hover:bg-green-600 transition duration-200 text-sm md:text-base">
                    üí¨ G√©rer mes conversations
                </button>
                <button onclick="confirmDeleteAccount()" class="w-full bg-red-500 text-white py-2 md:py-3 rounded-lg hover:bg-red-600 transition duration-200 text-sm md:text-base">
                    üóëÔ∏è Supprimer mon compte
                </button>
                <button onclick="closeSettingsModal()" class="w-full bg-gray-300 text-gray-700 py-2 md:py-3 rounded-lg hover:bg-gray-400 transition duration-200 text-sm md:text-base">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour g√©rer les contacts -->
    <div id="manageContactsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-md max-h-[80vh] flex flex-col">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">G√©rer mes contacts</h3>
            <div id="contactsManagementList" class="space-y-2 flex-1 overflow-y-auto mb-4">
                <!-- Les contacts seront ajout√©s ici -->
            </div>
            <button onclick="closeManageContactsModal()" class="w-full bg-gray-300 text-gray-700 py-2 md:py-3 rounded-lg hover:bg-gray-400 transition duration-200 text-sm md:text-base">
                Fermer
            </button>
        </div>
    </div>

    <!-- Modal pour g√©rer les conversations -->
    <div id="manageConversationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-md max-h-[80vh] flex flex-col">
            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">G√©rer mes conversations</h3>
            <div id="conversationsManagementList" class="space-y-2 flex-1 overflow-y-auto mb-4">
                <!-- Les conversations seront ajout√©es ici -->
            </div>
            <button onclick="closeManageConversationsModal()" class="w-full bg-gray-300 text-gray-700 py-2 md:py-3 rounded-lg hover:bg-gray-400 transition duration-200 text-sm md:text-base">
                Fermer
            </button>
        </div>
    </div>

    <!-- Modal pour voir une story -->
    <div id="viewStoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg md:text-xl font-bold text-gray-800" id="storyAuthor"></h3>
                <button onclick="closeViewStoryModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
            </div>
            <div id="storyContent" class="space-y-4">
                <!-- Le contenu de la story sera ajout√© ici -->
            </div>
            <div class="text-sm text-gray-500 mt-4" id="storyTimestamp"></div>
        </div>
    </div>

    <script>
        // Hash password (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Fonction pour √©chapper le HTML et √©viter les probl√®mes d'affichage
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Variables globales
        let currentUser = null;
        let currentChat = null;
        let users = JSON.parse(localStorage.getItem('messagapp_users') || '{}');
        let stories = JSON.parse(localStorage.getItem('messagapp_stories') || '{}');
        let currentPhotoMode = null; // 'message' ou 'story'
        let currentPhotoData = null;

        // Fonction pour cr√©er un compte
        async function createAccount() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showMessage('Veuillez remplir tous les champs', 'error');
                return;
            }

            if (username.length < 3) {
                showMessage('Le pseudo doit contenir au moins 3 caract√®res', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }

            if (users[username]) {
                showMessage('Ce pseudo existe d√©j√†', 'error');
                return;
            }

            // Cr√©er le compte
            const hashedPassword = await hashPassword(password);
            users[username] = {
                password: hashedPassword,
                createdAt: new Date().toISOString(),
                contacts: [],
                conversations: {}
            };

            localStorage.setItem('messagapp_users', JSON.stringify(users));
            showMessage('Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.', 'success');
            
            // Vider les champs
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        // Fonction pour se connecter
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showMessage('Veuillez remplir tous les champs', 'error');
                return;
            }

            if (!users[username]) {
                showMessage('Pseudo ou mot de passe incorrect', 'error');
                return;
            }

            const hashedPassword = await hashPassword(password);
            if (users[username].password !== hashedPassword) {
                showMessage('Pseudo ou mot de passe incorrect', 'error');
                return;
            }

            // Connexion r√©ussie
            currentUser = username;
            showMessage('Connexion r√©ussie !', 'success');
            
            setTimeout(() => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initializeApp();
            }, 1000);
        }

        // Fonction pour afficher les messages
        function showMessage(text, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.textContent = text;
            messageDiv.className = `text-center text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }

        // Fonction pour initialiser l'application apr√®s connexion
        function initializeApp() {
            // Mettre √† jour les informations utilisateur
            document.getElementById('currentUserName').textContent = currentUser;
            document.getElementById('userInitial').textContent = currentUser.charAt(0).toUpperCase();
            
            // Charger les contacts et stories
            loadContacts();
            loadStories();
            
            // Initialiser la sidebar pour mobile
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }
        }

        // Fonction pour charger les contacts
        function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            const userContacts = users[currentUser].contacts || [];
            
            contactsList.innerHTML = '';
            
            if (userContacts.length === 0) {
                contactsList.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-4">
                        Aucun contact pour le moment.<br>
                        Cliquez sur "+ Nouveau" pour ajouter un contact.
                    </div>
                `;
                return;
            }
            
            userContacts.forEach(contactName => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'flex items-center space-x-3 p-4 hover:bg-gray-100 rounded-xl cursor-pointer transition duration-200 border border-gray-100 hover:border-purple-200 hover:shadow-sm';
                contactDiv.onclick = () => openChat(contactName);
                
                const lastMessage = getLastMessage(contactName);
                const unreadCount = getUnreadCount(contactName);
                
                contactDiv.innerHTML = `
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-base flex-shrink-0">
                        ${contactName.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <p class="font-semibold text-gray-800 truncate text-base">${contactName}</p>
                            ${unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center flex-shrink-0">${unreadCount}</span>` : ''}
                        </div>
                        <p class="text-sm text-gray-500 truncate leading-relaxed">${lastMessage || 'Aucun message'}</p>
                    </div>
                `;
                
                contactsList.appendChild(contactDiv);
            });
        }

        // Fonction pour obtenir le dernier message d'une conversation
        function getLastMessage(contactName) {
            const conversation = users[currentUser].conversations[contactName];
            if (!conversation || conversation.length === 0) return null;
            
            const lastMsg = conversation[conversation.length - 1];
            return lastMsg.text.length > 30 ? lastMsg.text.substring(0, 30) + '...' : lastMsg.text;
        }

        // Fonction pour obtenir le nombre de messages non lus
        function getUnreadCount(contactName) {
            const conversation = users[currentUser].conversations[contactName];
            if (!conversation) return 0;
            
            return conversation.filter(msg => !msg.read && msg.sender !== currentUser).length;
        }

        // Fonction pour ouvrir une conversation
        function openChat(contactName) {
            currentChat = contactName;
            
            // Masquer l'√©tat vide et afficher l'interface de chat
            document.getElementById('emptyChatState').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            // Mettre √† jour les informations du contact
            document.getElementById('chatContactName').textContent = contactName;
            document.getElementById('chatContactInitial').textContent = contactName.charAt(0).toUpperCase();
            
            // Charger les messages
            loadMessages(contactName);
            
            // Marquer les messages comme lus
            markMessagesAsRead(contactName);
            
            // Fermer la sidebar sur mobile
            if (window.innerWidth < 768) {
                closeSidebar();
            }
        }

        // Fonctions pour g√©rer la sidebar mobile
        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            overlay.classList.remove('hidden');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            overlay.classList.add('hidden');
        }

        // Fonction pour charger les messages d'une conversation
        function loadMessages(contactName) {
            const messagesContainer = document.getElementById('messagesContainer');
            const conversation = users[currentUser].conversations[contactName] || [];
            
            messagesContainer.innerHTML = '';
            
            if (conversation.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 text-sm">
                        Commencez votre conversation avec ${contactName} !
                    </div>
                `;
                return;
            }
            
            conversation.forEach(message => {
                const messageDiv = document.createElement('div');
                const isSent = message.sender === currentUser;
                
                messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'} mb-4`;
                
                let messageContent = '';
                
                if (message.photo) {
                    messageContent += `<img src="${message.photo}" class="w-full rounded-lg mb-2 max-w-64">`;
                }
                
                if (message.text) {
                    messageContent += `<p class="text-sm leading-relaxed break-words">${escapeHtml(message.text)}</p>`;
                }
                
                messageContent += `<p class="text-xs opacity-75 mt-2">${formatTime(message.timestamp)}</p>`;
                
                messageDiv.innerHTML = `
                    <div class="max-w-xs sm:max-w-sm lg:max-w-lg px-4 py-3 rounded-2xl text-white shadow-sm ${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'}">
                        ${messageContent}
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Faire d√©filer vers le bas
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fonction pour formater l'heure
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        // Fonction pour marquer les messages comme lus
        function markMessagesAsRead(contactName) {
            if (!users[currentUser].conversations[contactName]) return;
            
            users[currentUser].conversations[contactName].forEach(message => {
                if (message.sender !== currentUser) {
                    message.read = true;
                }
            });
            
            localStorage.setItem('messagapp_users', JSON.stringify(users));
            loadContacts(); // Recharger pour mettre √† jour les badges
        }

        // Fonction pour envoyer un message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChat) return;
            
            const message = {
                sender: currentUser,
                text: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Ajouter le message √† la conversation de l'utilisateur actuel
            if (!users[currentUser].conversations[currentChat]) {
                users[currentUser].conversations[currentChat] = [];
            }
            users[currentUser].conversations[currentChat].push(message);
            
            // Ajouter le message √† la conversation du destinataire (si il existe)
            if (users[currentChat]) {
                if (!users[currentChat].conversations[currentUser]) {
                    users[currentChat].conversations[currentUser] = [];
                }
                users[currentChat].conversations[currentUser].push(message);
                
                // Ajouter l'utilisateur actuel aux contacts du destinataire s'il n'y est pas
                if (!users[currentChat].contacts.includes(currentUser)) {
                    users[currentChat].contacts.push(currentUser);
                }
            }
            
            localStorage.setItem('messagapp_users', JSON.stringify(users));
            
            // Recharger les messages et contacts
            loadMessages(currentChat);
            loadContacts();
            
            // Vider le champ de saisie
            messageInput.value = '';
        }

        // Fonction pour afficher le modal d'ajout de contact
        function showAddContactModal() {
            document.getElementById('addContactModal').classList.remove('hidden');
            document.getElementById('contactUsernameInput').focus();
        }

        // Fonction pour fermer le modal d'ajout de contact
        function closeAddContactModal() {
            document.getElementById('addContactModal').classList.add('hidden');
            document.getElementById('contactUsernameInput').value = '';
            document.getElementById('contactMessage').classList.add('hidden');
        }

        // Fonction pour ajouter un contact
        function addContact() {
            const contactUsername = document.getElementById('contactUsernameInput').value.trim();
            
            if (!contactUsername) {
                showContactMessage('Veuillez entrer un pseudo', 'error');
                return;
            }
            
            if (contactUsername === currentUser) {
                showContactMessage('Vous ne pouvez pas vous ajouter vous-m√™me', 'error');
                return;
            }
            
            if (!users[contactUsername]) {
                showContactMessage('Cet utilisateur n\'existe pas', 'error');
                return;
            }
            
            if (users[currentUser].contacts.includes(contactUsername)) {
                showContactMessage('Ce contact existe d√©j√†', 'error');
                return;
            }
            
            // Ajouter le contact
            users[currentUser].contacts.push(contactUsername);
            localStorage.setItem('messagapp_users', JSON.stringify(users));
            
            showContactMessage('Contact ajout√© avec succ√®s !', 'success');
            
            setTimeout(() => {
                closeAddContactModal();
                loadContacts();
            }, 1000);
        }

        // Fonction pour afficher les messages dans le modal de contact
        function showContactMessage(text, type) {
            const messageDiv = document.getElementById('contactMessage');
            messageDiv.textContent = text;
            messageDiv.className = `text-center text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            messageDiv.classList.remove('hidden');
        }

        // Fonction pour se d√©connecter
        function logout() {
            currentUser = null;
            currentChat = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        // Fonctions pour les stories
        function loadStories() {
            const storiesContainer = document.getElementById('storiesContainer');
            const addButton = storiesContainer.querySelector('.story-ring');
            
            // Vider le conteneur mais garder le bouton d'ajout
            storiesContainer.innerHTML = '';
            storiesContainer.appendChild(addButton);
            
            // Charger les stories de tous les contacts
            const userContacts = users[currentUser].contacts || [];
            userContacts.forEach(contactName => {
                if (stories[contactName] && stories[contactName].length > 0) {
                    const latestStory = stories[contactName][stories[contactName].length - 1];
                    const storyAge = Date.now() - new Date(latestStory.timestamp).getTime();
                    
                    // Afficher seulement les stories de moins de 24h
                    if (storyAge < 24 * 60 * 60 * 1000) {
                        const storyDiv = document.createElement('div');
                        storyDiv.className = 'story-ring flex-shrink-0 cursor-pointer';
                        storyDiv.onclick = () => viewStory(contactName);
                        
                        storyDiv.innerHTML = `
                            <div class="story-inner">
                                <div class="w-12 h-12 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                    ${contactName.charAt(0).toUpperCase()}
                                </div>
                            </div>
                        `;
                        
                        storiesContainer.appendChild(storyDiv);
                    }
                }
            });
            
            // Ajouter ses propres stories
            if (stories[currentUser] && stories[currentUser].length > 0) {
                const latestStory = stories[currentUser][stories[currentUser].length - 1];
                const storyAge = Date.now() - new Date(latestStory.timestamp).getTime();
                
                if (storyAge < 24 * 60 * 60 * 1000) {
                    const storyDiv = document.createElement('div');
                    storyDiv.className = 'story-ring flex-shrink-0 cursor-pointer';
                    storyDiv.onclick = () => viewStory(currentUser);
                    
                    storyDiv.innerHTML = `
                        <div class="story-inner">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${currentUser.charAt(0).toUpperCase()}
                            </div>
                        </div>
                    `;
                    
                    storiesContainer.appendChild(storyDiv);
                }
            }
        }

        function showCreateStoryModal() {
            document.getElementById('createStoryModal').classList.remove('hidden');
            document.getElementById('storyTextInput').focus();
        }

        function closeCreateStoryModal() {
            document.getElementById('createStoryModal').classList.add('hidden');
            document.getElementById('storyTextInput').value = '';
            document.getElementById('storyPhotoPreview').classList.add('hidden');
            document.getElementById('storyMessage').classList.add('hidden');
            currentPhotoData = null;
        }

        function createStory() {
            const text = document.getElementById('storyTextInput').value.trim();
            
            if (!text && !currentPhotoData) {
                showStoryMessage('Ajoutez du texte ou une photo', 'error');
                return;
            }
            
            const story = {
                text: text,
                photo: currentPhotoData,
                timestamp: new Date().toISOString(),
                author: currentUser
            };
            
            if (!stories[currentUser]) {
                stories[currentUser] = [];
            }
            
            stories[currentUser].push(story);
            localStorage.setItem('messagapp_stories', JSON.stringify(stories));
            
            showStoryMessage('Story publi√©e !', 'success');
            
            setTimeout(() => {
                closeCreateStoryModal();
                loadStories();
            }, 1000);
        }

        function viewStory(username) {
            if (!stories[username] || stories[username].length === 0) return;
            
            const latestStory = stories[username][stories[username].length - 1];
            
            document.getElementById('storyAuthor').textContent = username;
            document.getElementById('storyTimestamp').textContent = formatTime(latestStory.timestamp);
            
            const storyContent = document.getElementById('storyContent');
            storyContent.innerHTML = '';
            
            if (latestStory.photo) {
                const img = document.createElement('img');
                img.src = latestStory.photo;
                img.className = 'w-full rounded-lg';
                storyContent.appendChild(img);
            }
            
            if (latestStory.text) {
                const textDiv = document.createElement('div');
                textDiv.className = 'text-gray-800 text-lg';
                textDiv.textContent = latestStory.text;
                storyContent.appendChild(textDiv);
            }
            
            document.getElementById('viewStoryModal').classList.remove('hidden');
        }

        function closeViewStoryModal() {
            document.getElementById('viewStoryModal').classList.add('hidden');
        }

        function showStoryMessage(text, type) {
            const messageDiv = document.getElementById('storyMessage');
            messageDiv.textContent = text;
            messageDiv.className = `text-center text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            messageDiv.classList.remove('hidden');
        }

        // Fonctions pour les photos
        function showPhotoModal(mode) {
            currentPhotoMode = mode;
            document.getElementById('photoModal').classList.remove('hidden');
            clearPhoto();
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            currentPhotoMode = null;
        }

        async function drawRandomPhoto() {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Ajuster la taille du canvas pour mobile
            const isMobile = window.innerWidth < 768;
            canvas.width = isMobile ? 250 : 300;
            canvas.height = isMobile ? 188 : 225;
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            try {
                // Essayer d'acc√©der √† la cam√©ra
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: canvas.width, 
                        height: canvas.height,
                        facingMode: 'user'
                    } 
                });
                
                // Cr√©er un √©l√©ment vid√©o temporaire
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.muted = true;
                
                // Attendre que la vid√©o soit pr√™te
                video.onloadedmetadata = () => {
                    video.play();
                    
                    // Prendre une photo apr√®s un court d√©lai
                    setTimeout(() => {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Arr√™ter le stream
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Ajouter un effet photo
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Ajouter un timestamp
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        ctx.fillRect(5, canvas.height - 25, 120, 20);
                        ctx.fillStyle = 'white';
                        ctx.font = '12px Arial';
                        ctx.fillText(new Date().toLocaleString('fr-FR'), 10, canvas.height - 10);
                    }, 1000);
                };
                
            } catch (error) {
                console.log('Cam√©ra non disponible, g√©n√©ration d\'une photo artistique');
                generateArtisticPhoto(ctx, canvas.width, canvas.height, isMobile);
            }
        }
        
        function generateArtisticPhoto(ctx, width, height, isMobile) {
            // Cr√©er un paysage artistique
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#87CEEB'); // Ciel bleu
            gradient.addColorStop(0.7, '#98FB98'); // Vert clair
            gradient.addColorStop(1, '#228B22'); // Vert fonc√©
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Ajouter un soleil
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(width * 0.8, height * 0.2, isMobile ? 20 : 25, 0, 2 * Math.PI);
            ctx.fill();
            
            // Ajouter des nuages
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                const x = (width / 4) * (i + 0.5);
                const y = height * 0.15 + Math.random() * 30;
                
                // Nuage compos√© de cercles
                for (let j = 0; j < 4; j++) {
                    ctx.beginPath();
                    ctx.arc(x + j * 8, y, 12, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            
            // Ajouter des montagnes
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.moveTo(0, height * 0.6);
            ctx.lineTo(width * 0.3, height * 0.4);
            ctx.lineTo(width * 0.6, height * 0.5);
            ctx.lineTo(width, height * 0.3);
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fill();
            
            // Ajouter des arbres
            for (let i = 0; i < 5; i++) {
                const treeX = Math.random() * width;
                const treeY = height * 0.7 + Math.random() * (height * 0.2);
                
                // Tronc
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(treeX - 3, treeY, 6, height - treeY);
                
                // Feuillage
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.arc(treeX, treeY - 10, 15, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // Ajouter un timestamp
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(5, height - 25, 120, 20);
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(new Date().toLocaleString('fr-FR'), 10, height - 10);
        }

        function clearPhoto() {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Ajuster la taille du canvas pour mobile
            const isMobile = window.innerWidth < 768;
            canvas.width = isMobile ? 250 : 300;
            canvas.height = isMobile ? 188 : 225;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#9ca3af';
            ctx.font = `${isMobile ? '12px' : '16px'} Arial`;
            ctx.textAlign = 'center';
            
            if (isMobile) {
                ctx.fillText('Cliquez sur "Prendre photo"', canvas.width / 2, canvas.height / 2 - 10);
                ctx.fillText('pour capturer une image', canvas.width / 2, canvas.height / 2 + 10);
            } else {
                ctx.fillText('Cliquez sur "Prendre photo" pour capturer une image', canvas.width / 2, canvas.height / 2);
            }
        }

        function usePhoto() {
            const canvas = document.getElementById('photoCanvas');
            const photoData = canvas.toDataURL();
            
            if (currentPhotoMode === 'story') {
                currentPhotoData = photoData;
                const preview = document.getElementById('storyPhotoPreview');
                const previewCanvas = document.getElementById('storyPhotoCanvas');
                const previewCtx = previewCanvas.getContext('2d');
                
                const img = new Image();
                img.onload = function() {
                    previewCanvas.width = 200;
                    previewCanvas.height = 150;
                    previewCtx.drawImage(img, 0, 0, 200, 150);
                };
                img.src = photoData;
                
                preview.classList.remove('hidden');
                closePhotoModal();
            } else if (currentPhotoMode === 'message') {
                sendPhotoMessage(photoData);
                closePhotoModal();
            }
        }

        function sendPhotoMessage(photoData) {
            if (!currentChat) return;
            
            const message = {
                sender: currentUser,
                text: '',
                photo: photoData,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Ajouter le message √† la conversation
            if (!users[currentUser].conversations[currentChat]) {
                users[currentUser].conversations[currentChat] = [];
            }
            users[currentUser].conversations[currentChat].push(message);
            
            // Ajouter le message √† la conversation du destinataire
            if (users[currentChat]) {
                if (!users[currentChat].conversations[currentUser]) {
                    users[currentChat].conversations[currentUser] = [];
                }
                users[currentChat].conversations[currentUser].push(message);
            }
            
            localStorage.setItem('messagapp_users', JSON.stringify(users));
            
            // Recharger les messages et contacts
            loadMessages(currentChat);
            loadContacts();
        }

        // Fonctions pour les param√®tres
        function showSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function showManageContactsModal() {
            closeSettingsModal();
            const contactsList = document.getElementById('contactsManagementList');
            const userContacts = users[currentUser].contacts || [];
            
            contactsList.innerHTML = '';
            
            if (userContacts.length === 0) {
                contactsList.innerHTML = '<div class="text-center text-gray-500">Aucun contact</div>';
                document.getElementById('manageContactsModal').classList.remove('hidden');
                return;
            }
            
            userContacts.forEach(contactName => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                
                contactDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                            ${contactName.charAt(0).toUpperCase()}
                        </div>
                        <span class="font-medium">${contactName}</span>
                    </div>
                    <button onclick="removeContact('${contactName}')" class="text-red-500 hover:text-red-700 text-sm">
                        üóëÔ∏è Supprimer
                    </button>
                `;
                
                contactsList.appendChild(contactDiv);
            });
            
            document.getElementById('manageContactsModal').classList.remove('hidden');
        }

        function closeManageContactsModal() {
            document.getElementById('manageContactsModal').classList.add('hidden');
        }

        function removeContact(contactName) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${contactName} de vos contacts ?`)) {
                users[currentUser].contacts = users[currentUser].contacts.filter(c => c !== contactName);
                localStorage.setItem('messagapp_users', JSON.stringify(users));
                loadContacts();
                showManageContactsModal();
            }
        }

        function showManageConversationsModal() {
            closeSettingsModal();
            const conversationsList = document.getElementById('conversationsManagementList');
            const userConversations = users[currentUser].conversations || {};
            
            conversationsList.innerHTML = '';
            
            const conversationNames = Object.keys(userConversations);
            if (conversationNames.length === 0) {
                conversationsList.innerHTML = '<div class="text-center text-gray-500">Aucune conversation</div>';
                document.getElementById('manageConversationsModal').classList.remove('hidden');
                return;
            }
            
            conversationNames.forEach(contactName => {
                const conversation = userConversations[contactName];
                const messageCount = conversation.length;
                
                const conversationDiv = document.createElement('div');
                conversationDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                
                conversationDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                            ${contactName.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <span class="font-medium">${contactName}</span>
                            <div class="text-sm text-gray-500">${messageCount} message${messageCount > 1 ? 's' : ''}</div>
                        </div>
                    </div>
                    <button onclick="deleteConversation('${contactName}')" class="text-red-500 hover:text-red-700 text-sm">
                        üóëÔ∏è Supprimer
                    </button>
                `;
                
                conversationsList.appendChild(conversationDiv);
            });
            
            document.getElementById('manageConversationsModal').classList.remove('hidden');
        }

        function closeManageConversationsModal() {
            document.getElementById('manageConversationsModal').classList.add('hidden');
        }

        function deleteConversation(contactName) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la conversation avec ${contactName} ?`)) {
                delete users[currentUser].conversations[contactName];
                localStorage.setItem('messagapp_users', JSON.stringify(users));
                
                if (currentChat === contactName) {
                    currentChat = null;
                    document.getElementById('emptyChatState').classList.remove('hidden');
                    document.getElementById('chatInterface').classList.add('hidden');
                }
                
                loadContacts();
                showManageConversationsModal();
            }
        }

        function confirmDeleteAccount() {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer d√©finitivement votre compte ? Cette action est irr√©versible.')) {
                if (confirm('Derni√®re confirmation : toutes vos donn√©es seront perdues. Continuer ?')) {
                    deleteAccount();
                }
            }
        }

        function deleteAccount() {
            // Supprimer l'utilisateur
            delete users[currentUser];
            
            // Supprimer ses stories
            delete stories[currentUser];
            
            // Supprimer l'utilisateur des contacts des autres
            Object.keys(users).forEach(username => {
                if (users[username].contacts) {
                    users[username].contacts = users[username].contacts.filter(c => c !== currentUser);
                }
                if (users[username].conversations && users[username].conversations[currentUser]) {
                    delete users[username].conversations[currentUser];
                }
            });
            
            localStorage.setItem('messagapp_users', JSON.stringify(users));
            localStorage.setItem('messagapp_stories', JSON.stringify(stories));
            
            alert('Votre compte a √©t√© supprim√© avec succ√®s.');
            logout();
        }

        // Fonction pour afficher/masquer le mot de passe
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('passwordInput');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = 'üëÅÔ∏è';
            }
        }

        // Permettre la connexion avec la touche Entr√©e
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('#usernameInput, #passwordInput');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            });

            // Permettre l'envoi de message avec Entr√©e
            document.addEventListener('keypress', function(e) {
                if (e.target.id === 'messageInput' && e.key === 'Enter') {
                    sendMessage();
                }
                if (e.target.id === 'contactUsernameInput' && e.key === 'Enter') {
                    addContact();
                }
            });

            // Fermer les modals avec √âchap
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAddContactModal();
                    closeCreateStoryModal();
                    closePhotoModal();
                    closeSettingsModal();
                    closeManageContactsModal();
                    closeManageConversationsModal();
                    closeViewStoryModal();
                    closeSidebar();
                }
            });

            // G√©rer le redimensionnement de la fen√™tre
            window.addEventListener('resize', function() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (window.innerWidth >= 768) {
                    // Desktop: afficher la sidebar normalement
                    sidebar.classList.remove('-translate-x-full', 'translate-x-0');
                    overlay.classList.add('hidden');
                } else {
                    // Mobile: masquer la sidebar par d√©faut
                    if (!overlay.classList.contains('hidden')) {
                        // Si l'overlay est visible, garder la sidebar ouverte
                        sidebar.classList.add('translate-x-0');
                        sidebar.classList.remove('-translate-x-full');
                    } else {
                        // Sinon, masquer la sidebar
                        sidebar.classList.add('-translate-x-full');
                        sidebar.classList.remove('translate-x-0');
                    }
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e153f7c441e275',t:'MTc1NTAxNTkxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
